GROWFS_DISK=sd0
GROWFS_PART=/dev/sd0a

KEYDISK=sd1
KEYDISK_PART=/dev/sd1a
USE_KEYDISK=yes

rootdisk=$(dmesg | sed -E '/^root on ([^ ]+) .*$/h;$!d;g;s//\1/')
mount -u /dev/${rootdisk:-rd0a} /

echo ! : >/etc/rc

[[ -x /sbin/slaacd ]] && /sbin/slaacd


old_pwd=$(pwd)
cd /dev
sh ./MAKEDEV $GROWFS_DISK

if [[ $USE_KEYDISK == "yes" ]]; then
	cd /dev
	sh ./MAKEDEV $KEYDISK
	fdisk -iy $KEYDISK
	print 'd *\na\na\n\n1M\nRAID\nw\n' | disklabel -E $KEYDISK
fi

fdisk -iy $GROWFS_DISK


# grow disklabel area
print 'b\n\n*\nw\n' | disklabel -E $GROWFS_DISK

# prepare for disklabel for encryption with bioctl
print 'd *\na\na\n\n*\nRAID\nw\n' | disklabel -E $GROWFS_DISK

# encrypt disk
if [[ $USE_KEYDISK == "no" ]]; then
	bioctl -c C -p /passphrase -l $GROWFS_PART softraid0
elif [[ $USE_KEYDISK == "yes" ]]; then
	bioctl -c C -k $KEYDISK_PART -l $GROWFS_PART softraid0
fi

cd $old_pwd
